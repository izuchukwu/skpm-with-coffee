#!/usr/bin/env node
'use strict';

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _yargs = require('yargs');

var _yargs2 = _interopRequireDefault(_yargs);

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _simplePlist = require('simple-plist');

var _simplePlist2 = _interopRequireDefault(_simplePlist);

var _semver = require('semver');

var _semver2 = _interopRequireDefault(_semver);

var _toolConfig = require('@skpm/utils/tool-config');

var _skpmConfig = require('@skpm/utils/skpm-config');

var _skpmConfig2 = _interopRequireDefault(_skpmConfig);

var _exec = require('@skpm/utils/exec');

var _exec2 = _interopRequireDefault(_exec);

var _getSketchVersion = require('./utils/getSketchVersion');

var _getSketchVersion2 = _interopRequireDefault(_getSketchVersion);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _getConfig = (0, _toolConfig.get)();

const pluginDirectory = _getConfig.pluginDirectory;


function testDevMode(then) {
  const prefPath = (0, _path.join)(require('os').homedir(), 'Library/Preferences/com.bohemiancoding.sketch3.plist');
  const data = _simplePlist2.default.readFileSync(prefPath);

  if (!data.AlwaysReloadScript) {
    const yesno = require('yesno');
    console.log(`The sketch developer mode is not enabled ${_chalk2.default.dim('(http://developer.sketchapp.com/introduction/preferences/#always-reload-scripts-before-running)')}.`);
    yesno.ask('Do you want to enable it? (y/N)', false, ok => {
      if (ok) {
        _exec2.default.exec(`defaults write ${prefPath} AlwaysReloadScript -bool YES`).then(then, then);
      } else {
        then();
      }
    });
  } else {
    then();
  }
}

_yargs2.default.help().strict().usage('Usage: cd path/to/my/plugin && skpm-link').argv;

const path = '.';

if (path.indexOf(pluginDirectory) !== -1) {
  console.error(`${_chalk2.default.red('error')} The path should be the one pointing to your new plugin folder, not the sketch plugins folder`);
  process.exit(1);
}

function getPath(file) {
  return path === '/' ? (0, _path.join)(path, file) // absolute path
  : (0, _path.join)(process.cwd(), path, file); // relative path
}

let packageJSON;
try {
  packageJSON = require(getPath('package.json'));
} catch (err) {
  console.error(`${_chalk2.default.red('error')} Error while reading the package.json file`);
  console.error(err);
  process.exit(1);
}

const skpmConfig = (0, _skpmConfig2.default)(packageJSON);

if (!skpmConfig.main) {
  console.error(`${_chalk2.default.red('error')} Missing "skpm.main" fields in the package.json. Should point to the ".sketchplugin" file`);
  process.exit(1);
}

if (!skpmConfig.name) {
  console.error(`${_chalk2.default.red('error')} Missing "name" field in the package.json.`);
  process.exit(1);
}

console.log(`${_chalk2.default.dim('[1/1]')} ðŸ”—  Symlinking the plugin ${skpmConfig.name}...`);

try {
  // Create the encompassing directory if it doesn't already exist
  if (!_fs2.default.existsSync((0, _path.join)(pluginDirectory, skpmConfig.name))) {
    _fs2.default.mkdirSync((0, _path.join)(pluginDirectory, skpmConfig.name));
  }

  // Show an error if this symlink already exists
  if (_fs2.default.existsSync((0, _path.join)(pluginDirectory, skpmConfig.name, skpmConfig.main))) {
    console.log(`${_chalk2.default.red('error')} This plugin has already been linked.`);
    process.exit(0);
  }

  // Create the symlink within the encompassing directory
  _fs2.default.symlinkSync(getPath(skpmConfig.main), (0, _path.join)(pluginDirectory, skpmConfig.name, skpmConfig.main));

  testDevMode(() => {
    (0, _getSketchVersion2.default)().then(sketchVersion => {
      if (sketchVersion && _semver2.default.gte(sketchVersion, '45.0.0')) {
        console.log();
        console.log(`${_chalk2.default.yellow('warning')} Starting with Sketch 45, you need to restart Sketch for your plugin to appear in the "plugins" menu`);
        console.log();
      }
    });
    console.log(`${_chalk2.default.green('success')} Plugin ${skpmConfig.name} symlinked`);
    console.log(`${_chalk2.default.blue(skpmConfig.name)} - ${_chalk2.default.grey(skpmConfig.version)}`);
    process.exit(0);
  });
} catch (err) {
  console.log(`${_chalk2.default.red('error')} Error while symlinking the plugin ${skpmConfig.name}`);
  console.log((err || {}).body || err);
  process.exit(1);
}